# Copyright (c) 2014 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description   "Start the autotest scheduler."
author        "chromium-os-dev@chromium.org"

start on (started moblab-apache-init and
          stopped moblab-external-storage-init RESULT=ok and
          stopped moblab-base-container-init RESULT=ok)
respawn

normal exit 0

env ATEST_RESULTS_DIR=/usr/local/autotest/results
env CROS_VENV_CACHE=/usr/local/.cros-venv-cache

script
  mkdir -p /var/log/bootup/
  exec >>/var/log/bootup/${UPSTART_JOB}.log 2>&1
  set -x
  set -e
  logger -t "${UPSTART_JOB}" "Starting."
end script

exec sudo -u moblab /usr/local/autotest/scheduler/monitor_db.py \
  "${ATEST_RESULTS_DIR}"
